#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"

if [[ -f .env ]]; then
  # shellcheck disable=SC1091
  source .env
fi

web_profile="${WEB_SERVER:-apache}"
tld="${TLD:-loc}"
compose=(docker compose)
CERT_DIR="config/certs"
CERT_FILE="${CERT_DIR}/devbox.${tld}.pem"
KEY_FILE="${CERT_DIR}/devbox.${tld}-key.pem"
WP_CLI_PHAR_URL="https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar"

cmd="${1:-help}"; shift || true

require_docker() {
  if ! command -v docker >/dev/null 2>&1; then
    echo "Error: docker is not installed or not in PATH." >&2
    exit 1
  fi
}

ensure_site_name() {
  local name="${1:-}"
  if [[ -z "$name" ]]; then
    echo "Usage: devbox add-site <name> [--with-wp]" >&2
    exit 1
  fi
  if [[ ! "$name" =~ ^[a-z0-9-]+$ ]]; then
    echo "Error: site name must match ^[a-z0-9-]+$" >&2
    exit 1
  fi
}

db_name_for_site() {
  local name="$1"
  local db="wp_${name//-/_}"
  echo "$db"
}

print_urls() {
  echo "Dashboard: http://localhost:${DASHBOARD_PORT:-19000}"
  echo "Mailpit:   http://localhost:${MAILPIT_UI_PORT:-18025}"
  echo "Adminer:   http://localhost:${ADMINER_PORT:-18081}"
  echo "HTTP:      http://<site>.${tld}:${HTTP_PORT:-18080}"
  echo "HTTPS:     https://<site>.${tld}:${HTTPS_PORT:-18443}"
  echo "DB host:   127.0.0.1:${MYSQL_PORT:-13307}"
}

ensure_wp_cli() {
  require_docker

  if "${compose[@]}" exec -T php sh -lc 'command -v wp >/dev/null 2>&1'; then
    return 0
  fi

  echo "WP-CLI missing in php container -> installing..."
  "${compose[@]}" exec -T php sh -lc "set -e; curl -fsSL '$WP_CLI_PHAR_URL' -o /usr/local/bin/wp; chmod +x /usr/local/bin/wp"

  if ! "${compose[@]}" exec -T php sh -lc 'command -v wp >/dev/null 2>&1'; then
    echo "Error: WP-CLI install failed in php container." >&2
    exit 1
  fi

  echo "✅ WP-CLI installed"
}

ssl_init() {
  mkdir -p "$CERT_DIR"

  if [[ -f "$CERT_FILE" && -f "$KEY_FILE" ]]; then
    echo "SSL cert already present: $CERT_FILE"
    return 0
  fi

  if ! command -v mkcert >/dev/null 2>&1; then
    echo "mkcert not found. Install first, then run: ./bin/devbox ssl-init" >&2
    echo "macOS: brew install mkcert nss && mkcert -install" >&2
    exit 1
  fi

  echo "Generating local CA certs for *.${tld} ..."
  mkcert -install
  mkcert -cert-file "$CERT_FILE" -key-file "$KEY_FILE" "*.${tld}" "${tld}" "localhost" "127.0.0.1" "::1"

  echo "✅ SSL ready"
  echo "   cert: $CERT_FILE"
  echo "   key : $KEY_FILE"
}

add_site() {
  require_docker

  local site="$1"; shift || true
  local with_wp="false"
  if [[ "${1:-}" == "--with-wp" ]]; then
    with_wp="true"
  fi

  ensure_site_name "$site"

  local site_dir="data/www/${site}"
  local db_name
  db_name="$(db_name_for_site "$site")"

  mkdir -p "$site_dir"
  mkdir -p data/www/general

  if [[ ! -f "$site_dir/index.php" && "$with_wp" != "true" ]]; then
    cat > "$site_dir/index.php" <<PHP
<?php
// Placeholder for ${site}
phpinfo();
PHP
  fi

  if [[ ! -f "$CERT_FILE" || ! -f "$KEY_FILE" ]]; then
    echo "SSL certs missing -> attempting ./bin/devbox ssl-init"
    ssl_init || {
      echo "Continuing without HTTPS cert generation. Run ./bin/devbox ssl-init later." >&2
    }
  fi

  echo "[1/4] Ensuring containers are running..."
  "${compose[@]}" --profile "$web_profile" up -d db php "$web_profile"

  echo "[2/4] Creating database ${db_name} (if missing)..."
  "${compose[@]}" exec -T db sh -lc "mysql -uroot -p\"${MYSQL_ROOT_PASSWORD:-root}\" -e \"CREATE DATABASE IF NOT EXISTS \\\`${db_name}\\\` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\""

  if [[ "$with_wp" == "true" ]]; then
    ensure_wp_cli
    echo "[3/4] Installing WordPress core files..."
    "${compose[@]}" exec -T php sh -lc "cd /var/www/html/${site} && wp core download --allow-root"
    cat > "${site_dir}/wp-config.devbox.php" <<CFG
<?php
// Optional helper for wp-config.php include.
define('DB_NAME', '${db_name}');
define('DB_USER', '${MYSQL_USER:-wp}');
define('DB_PASSWORD', '${MYSQL_PASSWORD:-wp}');
define('DB_HOST', 'db');
CFG
    echo "Created ${site_dir}/wp-config.devbox.php"
  fi

  echo "[4/4] Reloading web server..."
  if [[ "$web_profile" == "nginx" ]]; then
    "${compose[@]}" exec -T nginx nginx -s reload >/dev/null 2>&1 || true
  else
    "${compose[@]}" exec -T apache httpd -k graceful >/dev/null 2>&1 || true
  fi

  echo
  echo "✅ Site created: ${site}"
  echo "   Domain: ${site}.${tld}"
  echo "   HTTP:   http://${site}.${tld}:${HTTP_PORT:-18080}"
  echo "   HTTPS:  https://${site}.${tld}:${HTTPS_PORT:-18443}"
  echo "   DB:     ${db_name}"
  echo
  echo "Host resolution setup (choose one):"
  echo "- Recommended (dnsmasq): run ./bin/devbox dns-setup"
  echo "- Fallback /etc/hosts entry: 127.0.0.1 ${site}.${tld}"
}

dns_setup() {
  cat <<TXT
macOS dnsmasq setup for *.${tld} -> 127.0.0.1

1) brew install dnsmasq
2) echo 'address=/.${tld}/127.0.0.1' | sudo tee /opt/homebrew/etc/dnsmasq.d/${tld}.conf
   (Intel path often: /usr/local/etc/dnsmasq.d/${tld}.conf)
3) sudo mkdir -p /etc/resolver
4) echo 'nameserver 127.0.0.1' | sudo tee /etc/resolver/${tld}
5) sudo brew services restart dnsmasq

Test:
  dig +short test.${tld}
Should return 127.0.0.1
TXT
}

doctor() {
  require_docker

  local ok=0
  local warn=0
  local fail=0

  mark_ok() {
    ok=$((ok + 1))
    echo "✅ $1"
  }

  mark_warn() {
    warn=$((warn + 1))
    echo "⚠️  $1"
  }

  mark_fail() {
    fail=$((fail + 1))
    echo "❌ $1"
  }

  echo "WPDevBox Doctor"
  echo "-------------"
  echo "Profile: $web_profile"

  if docker info >/dev/null 2>&1; then
    mark_ok "Docker daemon reachable"
  else
    mark_fail "Docker daemon not reachable"
  fi

  if [[ -f .env ]]; then
    mark_ok ".env present"
  else
    mark_warn ".env missing (copy .env.example -> .env)"
  fi

  if [[ -f "$CERT_FILE" && -f "$KEY_FILE" ]]; then
    mark_ok "SSL cert files present (${CERT_FILE##*/}, ${KEY_FILE##*/})"
  else
    mark_warn "SSL cert files missing (run ./bin/devbox ssl-init)"
  fi

  local key_perms=""
  if [[ -f "$KEY_FILE" ]]; then
    key_perms="$(stat -c '%a' "$KEY_FILE" 2>/dev/null || stat -f '%Lp' "$KEY_FILE" 2>/dev/null || true)"
  fi
  if [[ -n "$key_perms" ]]; then
    if [[ "$key_perms" == "644" || "$key_perms" == "640" ]]; then
      mark_ok "SSL key permissions look container-compatible ($key_perms)"
    else
      mark_warn "SSL key permissions are $key_perms (if Apache exits, try: chmod 644 $KEY_FILE)"
    fi
  fi

  if "${compose[@]}" ps --services --filter status=running | grep -qx db; then
    mark_ok "db running"
  else
    mark_fail "db not running"
  fi

  if "${compose[@]}" ps --services --filter status=running | grep -qx php; then
    mark_ok "php running"
  else
    mark_fail "php not running"
  fi

  if "${compose[@]}" --profile "$web_profile" ps --services --filter status=running | grep -qx "$web_profile"; then
    mark_ok "$web_profile running"
  else
    mark_fail "$web_profile not running"
  fi

  if "${compose[@]}" exec -T db sh -lc "mysqladmin ping -h localhost -u root -p\"${MYSQL_ROOT_PASSWORD:-root}\" >/dev/null 2>&1"; then
    mark_ok "database reachable"
  else
    mark_fail "database ping failed"
  fi

  if "${compose[@]}" exec -T php sh -lc 'command -v wp >/dev/null 2>&1'; then
    mark_ok "WP-CLI available in php container"
  else
    mark_warn "WP-CLI missing in php container (auto-installs on ./bin/devbox wp ...)"
  fi

  echo
  echo "Summary: ${ok} ok, ${warn} warnings, ${fail} failures"

  if (( fail > 0 )); then
    return 1
  fi
}

case "$cmd" in
  up)
    require_docker
    "${compose[@]}" --profile "$web_profile" up -d "$@"
    ;;
  down)
    require_docker
    "${compose[@]}" down "$@"
    ;;
  restart)
    require_docker
    "${compose[@]}" --profile "$web_profile" down
    "${compose[@]}" --profile "$web_profile" up -d
    ;;
  status)
    require_docker
    "${compose[@]}" ps
    echo
    print_urls
    ;;
  logs)
    require_docker
    "${compose[@]}" logs -f "${1:-}"
    ;;
  wp)
    require_docker
    ensure_wp_cli
    "${compose[@]}" exec -T php wp "$@"
    ;;
  add-site)
    add_site "$@"
    ;;
  ssl-init)
    ssl_init
    ;;
  dns-setup)
    dns_setup
    ;;
  doctor)
    doctor
    ;;
  help|*)
    cat <<USAGE
Usage: devbox <command>
  up|down|restart|status|logs [service]
  wp <args...>
  add-site <name> [--with-wp]
  ssl-init
  dns-setup
  doctor
USAGE
    ;;
esac
